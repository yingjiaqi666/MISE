<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Story Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h2 id="editor-title">Create New Story</h2>
    <div id="message" class="alert" style="display:none;"></div>

    <!-- Story Details Form -->
    <form id="story-form" class="card p-3 mb-4">
        <input type="hidden" id="storyId" name="storyId">
        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
            <label for="introduction" class="form-label">Introduction</label>
            <textarea class="form-control" id="introduction" rows="3"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Cover Image</label>
            <input type="hidden" id="cover">
            <input type="file" id="coverFile" accept="image/*" class="form-control mb-2">
            <img id="coverPreview" src="" alt="preview" style="max-width: 240px; display: none;"/>
            <div class="form-text">选择图片后会自动上传，并把图片地址保存到该故事</div>
        </div>
        <div class="mb-3">
            <label for="max" class="form-label">Max Players</label>
            <input type="number" class="form-control" id="max" value="1">
        </div>
        <div class="mb-3">
            <label for="firstSceneSelect" class="form-label">Starting Scene (choose one of your scenes)</label>
            <select id="firstSceneSelect" class="form-select">
                <option value="">-- None --</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Save Story Details</button>
    </form>

    <!-- Scenes editor removed: scene creation/management moved to separate Scene Editor -->
</div>

<!-- Scene modal removed from story editor (use Scene Editor page to edit/create scenes) -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const storyIdInput = document.getElementById('storyId');
    const messageDiv = document.getElementById('message');
    let currentStoryId = null;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');
        // Load user's scenes for selection of starting scene
        loadUserScenes();
        if (storyId) {
            currentStoryId = storyId;
            loadStoryForEditing(storyId);
        }
    });

    // auto upload when selecting file
    document.getElementById('coverFile').addEventListener('change', async function() {
        const input = this;
        if (!input.files || !input.files[0]) return;
        try {
            const url = await uploadImage(input.files[0]);
            document.getElementById('cover').value = url;
            const pv = document.getElementById('coverPreview');
            pv.src = url;
            pv.style.display = 'block';
        } catch (e) {
            showMessage('图片上传失败: ' + (e && e.message ? e.message : e), false);
        } finally {
            input.value = '';
        }
    });

    // Handle Story Form (Create/Update)
    document.getElementById('story-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const storyData = {
            name: document.getElementById('name').value,
            introduction: document.getElementById('introduction').value,
            cover: document.getElementById('cover').value,
            max: parseInt(document.getElementById('max').value, 10),
            firstSceneId: document.getElementById('firstSceneSelect').value ? parseInt(document.getElementById('firstSceneSelect').value, 10) : null
        };

        const isUpdate = !!currentStoryId;
        const url = isUpdate ? `/api/stories/${currentStoryId}` : '/api/stories/create';
        const method = isUpdate ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(storyData)
            });
            const result = await response.json();
            const isSuccess = result && result.code === '200';
            showMessage(result ? (result.msg || (isSuccess ? 'Success!' : 'An error occurred.')) : 'Unexpected response', isSuccess);

            if (isSuccess && !isUpdate) {
                window.location.search = `?storyId=${result.data}`;
            }
        } catch (error) {
            showMessage('An unexpected error occurred.', false);
        }
    });

    async function loadStoryForEditing(storyId) {
        try {
            const response = await fetch(`/api/stories/${storyId}`);
            const result = await response.json();
            if (result && result.code === '200') {
                const story = result.data;
                document.getElementById('editor-title').textContent = `Editing: ${story.name}`;
                storyIdInput.value = story.id;
                document.getElementById('name').value = story.name;
                document.getElementById('introduction').value = story.introduction;
                document.getElementById('cover').value = story.cover || '';
                if (story.cover) {
                    const pv = document.getElementById('coverPreview');
                    pv.src = story.cover;
                    pv.style.display = 'block';
                }
                document.getElementById('max').value = story.max;
                // Pre-select first scene if present
                if (story.firstSceneId) {
                    const sel = document.getElementById('firstSceneSelect');
                    sel.value = story.firstSceneId;
                }
            } else {
                showMessage(result ? result.msg : 'Failed to load story details.', false);
            }
        } catch (error) {
            showMessage('Failed to load story details.', false);
        }
    }

    async function loadUserScenes() {
        try {
            const res = await fetch('/api/scenes/my-scenes');
            const result = await res.json();
            if (result && result.code === '200') {
                const select = document.getElementById('firstSceneSelect');
                // keep existing default option
                result.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.name} (id:${s.id})`;
                    select.appendChild(opt);
                });
            }
        } catch (err) {
            console.warn('无法加载用户场景列表', err);
        }
    }

    function showMessage(msg, isSuccess) {
        messageDiv.textContent = msg;
        messageDiv.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
    }

    async function uploadImage(file) {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        let parsed = null;
        try {
            parsed = await res.clone().json();
        } catch (e) {
            const txt = await res.clone().text();
            throw new Error(`非JSON响应 (HTTP ${res.status}): ${txt.slice(0,200)}`);
        }
        if (!res.ok) {
            const msg = (parsed && parsed.msg) ? parsed.msg : `HTTP ${res.status} ${res.statusText}`;
            throw new Error(msg);
        }
        if (parsed && parsed.code === '200') {
            const data = parsed.data;
            return (data && (data.url || data)) || '';
        }
        throw new Error(parsed ? (parsed.msg || '上传返回失败') : 'upload failed');
    }

</script>
</body>
</html>
