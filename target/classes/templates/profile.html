<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h2>My Profile</h2>
    <div id="profile-info" class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">User Information</h5>
            <p><strong>Username:</strong> <span id="username"></span></p>
            <p><strong>Name:</strong> <span id="name"></span></p>
            <p><strong>Available Points:</strong> <span id="points" class="fw-bold text-primary"></span></p>
            <hr>
            <h5>Attributes</h5>
            <form id="attributes-form">
                <div class="row">
                    <div class="col-md-4 mb-2">Power: <span id="power-val" class="fw-bold"></span> <input type="number" id="power" class="form-control"></div>
                    <div class="col-md-4 mb-2">Agile: <span id="agile-val" class="fw-bold"></span> <input type="number" id="agile" class="form-control"></div>
                    <div class="col-md-4 mb-2">Perception: <span id="perception-val" class="fw-bold"></span> <input type="number" id="perception" class="form-control"></div>
                    <div class="col-md-4 mb-2">Intelligence: <span id="intelligence-val" class="fw-bold"></span> <input type="number" id="intelligence" class="form-control"></div>
                    <div class="col-md-4 mb-2">Charm: <span id="charm-val" class="fw-bold"></span> <input type="number" id="charm" class="form-control"></div>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Update Attributes</button>
                <button type="button" id="reset-attributes-btn" class="btn btn-warning mt-2">Reset Attributes</button>
            </form>
        </div>
    </div>

    <h4>My Products</h4>
    <div id="my-products" class="list-group mb-4">
        <!-- User's products will be loaded here -->
    </div>

    <h4>My Stories</h4>
    <div id="my-stories" class="list-group mb-4">
        <!-- User's stories will be loaded here -->
    </div>
</div>

<script>
    let originalAttributes = {};

    document.addEventListener('DOMContentLoaded', function () {
        fetchProfile();
        fetchMyStories();
    });

    async function fetchProfile() {
        try {
            const response = await fetch('/api/accounts/profile');
            const result = await response.json();
            if (result.code === '200') {
                const user = result.data;
                originalAttributes = { ...user }; // Store original state
                document.getElementById('username').textContent = user.username;
                document.getElementById('name').textContent = user.name || 'Not set';
                document.getElementById('points').textContent = user.points;
                
                document.getElementById('power').value = user.power;
                document.getElementById('agile').value = user.agile;
                document.getElementById('perception').value = user.perception;
                document.getElementById('intelligence').value = user.intelligence;
                document.getElementById('charm').value = user.charm;

                document.getElementById('power-val').textContent = `(${user.power})`;
                document.getElementById('agile-val').textContent = `(${user.agile})`;
                document.getElementById('perception-val').textContent = `(${user.perception})`;
                document.getElementById('intelligence-val').textContent = `(${user.intelligence})`;
                document.getElementById('charm-val').textContent = `(${user.charm})`;

                // Display products
                const productList = document.getElementById('my-products');
                productList.innerHTML = '';
                if (user.products && user.products.length > 0) {
                     user.products.forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.className = 'list-group-item';
                        productItem.innerHTML = `<strong>${product.name}</strong>: ${product.description}`;
                        productList.appendChild(productItem);
                    });
                } else {
                    productList.innerHTML = '<p>You have no products.</p>';
                }

            } else {
                document.getElementById('profile-info').innerHTML = `<p class="text-danger">Error: ${result.msg}</p>`;
            }
        } catch (error) {
            document.getElementById('profile-info').innerHTML = '<p class="text-danger">Failed to load profile.</p>';
        }
    }

    document.getElementById('attributes-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const updatedData = {
            power: parseInt(document.getElementById('power').value),
            agile: parseInt(document.getElementById('agile').value),
            perception: parseInt(document.getElementById('perception').value),
            intelligence: parseInt(document.getElementById('intelligence').value),
            charm: parseInt(document.getElementById('charm').value),
        };

        try {
            const response = await fetch('/api/accounts/profile/attributes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            const result = await response.json();
            if(result.code === '200') {
                alert(result.msg || 'Attributes updated successfully!');
                fetchProfile(); // Refresh profile data
            } else {
                alert(result.msg || 'Failed to update attributes.');
            }
        } catch (error) {
            alert('An error occurred while updating attributes.');
        }
    });

    document.getElementById('reset-attributes-btn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to reset your attributes? All points will be refunded.')) return;
        
        try {
            const response = await fetch('/api/accounts/profile/reset-attributes', { method: 'POST' });
            const result = await response.json();
            if(result.code === '200') {
                alert(result.msg || 'Attributes reset successfully!');
                fetchProfile(); // Refresh profile data
            } else {
                alert(result.msg || 'Failed to reset attributes.');
            }
        } catch (error) {
            alert('An error occurred while resetting attributes.');
        }
    });

    async function fetchMyStories() {
        const storyList = document.getElementById('my-stories');
        try {
            const response = await fetch('/api/stories/my-stories');
            const result = await response.json();
            if (result.code === '200' && result.data.length > 0) {
                storyList.innerHTML = '';
                result.data.forEach(story => {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'list-group-item';
                    const coverHtml = story.cover ? `<img src="${story.cover}" style="max-width:100px;max-height:70px;margin-right:12px;"/>` : '';
                    storyItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                ${coverHtml}
                                <h5 class="mb-1">${story.name}</h5>
                            </div>
                            <a href="/story-editor?storyId=${story.id}" class="btn btn-sm btn-outline-primary">Edit</a>
                        </div>
                        <p class="mb-1">${story.introduction}</p>
                    `;
                    storyList.appendChild(storyItem);
                });
            } else if (result.code === '200') {
                storyList.innerHTML = '<p>You have not created any stories yet.</p>';
            } else {
                storyList.innerHTML = `<p class="text-danger">Error: ${result.msg}</p>`;
            }
        } catch (error) {
            storyList.innerHTML = '<p class="text-danger">Failed to load your stories.</p>';
        }
    }
</script>
</body>
</html>
