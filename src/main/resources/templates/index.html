<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Game Lobby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <!-- 添加Bootstrap Icons用于音乐播放器 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h2 class="stories-title">Published Stories</h2>

    <div class="card p-4 mb-4">
        <div id="story-list" class="list-group">
            <div class="text-center text-muted py-4">
                <div class="spinner-border text-purple" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading stories...</p>
            </div>
        </div>
    </div>
</div>

<!-- 音乐播放器片段（放在Guide按钮之前） -->
<div th:replace="~{fragments/music-player :: music-player}"></div>

<!--&lt;!&ndash; 重新设计的云朵Guide按钮 &ndash;&gt;-->
<!--<a href="/guide" class="guide-btn-cloud">-->
<!--    <div class="cloud-shape"></div>-->
<!--    <div class="guide-text">Guide</div>-->
<!--</a>-->
<!-- 保持云朵样式的Guide按钮，添加下拉菜单功能 -->
<div class="guide-btn-container">
    <a href="#" class="guide-btn-cloud" onclick="toggleGuideMenu(event)">
        <div class="cloud-shape"></div>
        <div class="guide-text">Guide</div>
    </a>

    <!-- 自定义下拉菜单 -->
    <div id="guide-menu" class="guide-custom-menu" style="display: none;">
        <div class="guide-menu-item" onclick="goToVideoTutorial()">
            <i class="bi bi-play-circle"></i>
            <span>Video Tutorial</span>
        </div>
        <div class="guide-menu-item" onclick="startAutomaticOperation()">
            <i class="bi bi-magic"></i>
            <span>Automatic Operation</span>
        </div>
    </div>
</div>

<!-- 剩下的JavaScript和样式保持原样 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchStories();
    });

    async function fetchStories() {
        const storyList = document.getElementById('story-list');
        try {
            const response = await fetch('/api/stories');
            if (!response.ok) {
                storyList.innerHTML = '<div class="alert alert-danger">Failed to load stories. Server responded with an error.</div>';
                return;
            }
            const result = await response.json();
            if (result.code === '200' && result.data.length > 0) {
                storyList.innerHTML = ''; // Clear loading message
                result.data.forEach(story => {
                    const storyItem = document.createElement('a');
                    storyItem.href = `/play?storyId=${story.id}`;
                    storyItem.className = 'list-group-item list-group-item-action story-item mb-2';

                    const coverHtml = story.cover ?
                        `<img src="${story.cover}" class="story-cover-border" style="width: 100px; height: 75px; object-fit: cover; margin-right: 15px;"/>` :
                        `<div class="story-cover-border bg-light d-flex align-items-center justify-content-center" style="width: 100px; height: 75px; margin-right: 15px;">
                                <span class="text-muted">No Cover</span>
                            </div>`;

                    storyItem.innerHTML = `
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div class="d-flex align-items-center flex-grow-1">
                                    ${coverHtml}
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1">${story.name || 'Untitled Story'}</h5>
                                        <p class="mb-1 text-muted" style="font-size: 0.9rem;">${story.introduction || 'No introduction available.'}</p>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-purple fw-bold">By ${story.authorName || 'Unknown'}</small>
                                    <div class="mt-1">
                                        <small class="text-muted">${story.max || 1} player${story.max > 1 ? 's' : ''}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    storyList.appendChild(storyItem);
                });

                // Add some CSS for better hover effect
                addStoryItemStyles();

            } else if (result.code === '200') {
                storyList.innerHTML = `
                        <div class="text-center py-5">
                            <h4 class="text-muted mb-3">No stories have been published yet</h4>
                            <p class="mb-4">Be the first to create an amazing interactive story!</p>
                            <a href="/story-editor" class="btn btn-primary">Create Your First Story</a>
                        </div>`;
            } else {
                storyList.innerHTML = `<div class="alert alert-warning">Error: ${result.msg || 'An unknown error occurred.'}</div>`;
            }
        } catch (error) {
            storyList.innerHTML = '<div class="alert alert-danger">An unexpected error occurred while fetching stories.</div>';
        }
    }

    function addStoryItemStyles() {
        const style = document.createElement('style');
        style.textContent = `
                .story-item {
                    transition: all 0.3s ease;
                    border-left: 4px solid #9370DB;
                }
                .story-item:hover {
                    background: linear-gradient(135deg, rgba(147, 112, 219, 0.1), rgba(221, 160, 221, 0.1));
                    transform: translateX(5px);
                    border-left-color: #DDA0DD;
                }
                .story-item h5 {
                    color: #333;
                    transition: color 0.3s ease;
                }
                .story-item:hover h5 {
                    color: #9370DB;
                }
                .text-purple {
                    color: #9370DB !important;
                }
            `;
        document.head.appendChild(style);
    }
    // 控制Guide菜单的显示和隐藏
    function toggleGuideMenu(event) {
        event.preventDefault();
        event.stopPropagation();

        const menu = document.getElementById('guide-menu');
        const button = event.currentTarget;

        if (menu.style.display === 'none' || menu.style.display === '') {
            menu.style.display = 'block';
            button.classList.add('active');
        } else {
            menu.style.display = 'none';
            button.classList.remove('active');
        }
    }

    // 点击其他地方关闭菜单
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('guide-menu');
        const container = document.querySelector('.guide-btn-container');

        if (menu && !container.contains(event.target)) {
            menu.style.display = 'none';
            document.querySelector('.guide-btn-cloud').classList.remove('active');
        }
    });

    // 跳转到视频教程
    function goToVideoTutorial() {
        window.location.href = '/guide';
    }

    // 自动操作新手导航功能
    function startAutomaticOperation() {
        // 隐藏菜单
        document.getElementById('guide-menu').style.display = 'none';
        document.querySelector('.guide-btn-cloud').classList.remove('active');

        // 显示确认对话框
        if (confirm('开始自动新手导航？系统将自动为您演示如何使用平台功能。')) {
            beginAutomaticTutorial();
        }
    }

    async function beginAutomaticTutorial() {
        // 创建遮罩层和提示框
        createTutorialOverlay();

        // 步骤1: 介绍故事列表
        await showTutorialStep(
            'story-list',
            '欢迎来到游戏大厅！',
            '这里显示所有已发布的交互式故事。让我们先看看有哪些精彩的故事可以体验。',
            3000
        );

        // 步骤2: 如果有故事，高亮第一个故事
        const firstStory = document.querySelector('.story-item');
        if (firstStory) {
            await showTutorialStep(
                firstStory,
                '故事卡片',
                '点击任意故事卡片就可以开始游戏体验。每个故事都有独特的剧情和选择分支。',
                3000
            );
        }

        // 步骤3: 开始介绍顶部导航栏
        await showTutorialStep(
            '.navbar',
            '顶部导航栏',
            '现在让我为您介绍顶部导航栏的各个功能按钮。',
            2000
        );

        // 步骤4-10: 逐一介绍每个导航按钮
        const navButtons = [
            { selector: 'a[href="/"]', title: 'Home', description: '主页面 - 回到游戏大厅，浏览所有已发布的故事' },
            { selector: 'a[href="/story-editor"]', title: 'Create Story', description: '创建故事 - 开始创作您自己的交互式故事' },
            { selector: 'a[href="/scene-editor"]', title: 'Scene Editor', description: '编辑场景 - 创建和编辑故事中的各个场景' },
            { selector: 'a[href="/profile"]', title: 'Profile', description: '个人资料 - 查看和管理您的用户信息及属性' },
            { selector: 'a[href="/my-stories"]', title: 'My Stories', description: '我的故事 - 管理您创建的所有故事' },
            { selector: 'a[href="/my-scenes"]', title: 'My Scenes', description: '我的场景 - 管理您创建的所有场景' },
            { selector: 'a[href="/ai"]', title: 'Work with AI', description: '使用AI - 与AI助手协作，获得创作灵感和帮助' }
        ];

        for (let i = 0; i < navButtons.length; i++) {
            const button = navButtons[i];
            const element = document.querySelector(button.selector);
            if (element) {
                await showTutorialStep(
                    element,
                    button.title,
                    button.description,
                    2500
                );
            }
        }

        // 步骤11: 开始系统自动演示
        await showTutorialStep(
            '.navbar',
            '系统自动演示',
            '导航栏介绍完成！现在开始系统自动演示，我将带您体验如何设置角色属性。',
            3000
        );

        // 步骤12: 自动跳转到Profile页面并演示属性设置
        await demonstrateProfileAttributes();
    }

    // 演示Profile页面属性设置
    async function demonstrateProfileAttributes() {
        // 显示跳转提示
        await showTutorialStep(
            'a[href="/profile"]',
            '跳转到Profile页面',
            '现在我将自动跳转到Profile页面，演示如何设置角色属性。',
            2000
        );

        // 自动跳转到Profile页面
        window.location.href = '/profile?tutorial=auto';
    }

    // 在Profile页面执行的自动演示
    async function executeProfileDemo() {
        // 等待页面加载完成
        await new Promise(resolve => setTimeout(resolve, 1000));

        // 创建遮罩层
        createTutorialOverlay();

        // 步骤1: 介绍属性区域
        await showTutorialStep(
            '#attributes-form',
            '角色属性设置',
            '这里是角色属性设置区域。我将演示如何重置和设置属性点。',
            3000
        );

        // 步骤2: 高亮Reset按钮并自动点击
        const resetBtn = document.getElementById('reset-attributes-btn');
        if (resetBtn) {
            await showTutorialStep(
                resetBtn,
                '重置属性',
                '首先点击"Reset Attributes"按钮重置所有属性点。',
                2000
            );

            // 自动点击重置按钮
            await simulateClick(resetBtn, '正在重置属性...');

            // 等待重置完成
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        // 步骤3: 演示设置属性值
        await showTutorialStep(
            '#attributes-form',
            '设置属性值',
            '现在我将把所有属性都设置为2。',
            2000
        );

        // 自动设置所有属性为2
        const attributes = ['power', 'agile', 'perception', 'intelligence', 'charm'];
        for (let attr of attributes) {
            const input = document.getElementById(attr);
            if (input) {
                await showTutorialStep(
                    input,
                    `设置${attr.charAt(0).toUpperCase() + attr.slice(1)}`,
                    `将${attr}属性设置为2`,
                    1500
                );

                // 自动输入数值
                await simulateInput(input, '2');
            }
        }

        // 步骤4: 保存属性设置
        const updateBtn = document.querySelector('#attributes-form button[type="submit"]');
        if (updateBtn) {
            await showTutorialStep(
                updateBtn,
                '保存属性设置',
                '最后点击"Update Attributes"保存设置。',
                2000
            );

            // 自动点击保存按钮
            await simulateClick(updateBtn, '正在保存属性设置...');

            // 等待保存完成
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        // 演示完成
        await showTutorialStep(
            '#profile-info',
            '属性设置完成',
            '属性设置演示完成！您已经学会了如何管理角色属性。',
            3000
        );

        // 询问是否继续下一步演示
        const continueDemo = confirm('属性设置演示完成！是否继续下一步演示？');

        if (continueDemo) {
            // 这里可以添加下一步演示的逻辑
            alert('下一步演示功能正在开发中...');
            removeTutorialOverlay();
        } else {
            removeTutorialOverlay();
            alert('演示完成！您可以继续探索其他功能。');
        }
    }

    // 模拟点击操作
    function simulateClick(element, message) {
        return new Promise((resolve) => {
            // 显示操作提示
            const tooltip = createOperationTooltip(message);

            // 高亮元素
            element.style.boxShadow = '0 0 20px 5px rgba(255, 215, 0, 0.8)';
            element.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';

            setTimeout(() => {
                // 模拟点击
                element.click();

                // 恢复样式
                element.style.boxShadow = '';
                element.style.backgroundColor = '';

                // 移除提示
                if (tooltip && tooltip.parentNode) {
                    tooltip.remove();
                }

                resolve();
            }, 1500);
        });
    }

    // 模拟输入操作
    function simulateInput(element, value) {
        return new Promise((resolve) => {
            // 高亮元素
            element.style.boxShadow = '0 0 20px 5px rgba(255, 215, 0, 0.8)';
            element.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';

            // 清空并逐字输入
            element.value = '';
            element.focus();

            let i = 0;
            const inputInterval = setInterval(() => {
                if (i < value.length) {
                    element.value += value[i];
                    // 触发input事件
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    i++;
                } else {
                    clearInterval(inputInterval);

                    // 恢复样式
                    element.style.boxShadow = '';
                    element.style.backgroundColor = '';

                    resolve();
                }
            }, 300);
        });
    }

    // 创建操作提示框
    function createOperationTooltip(message) {
        const tooltip = document.createElement('div');
        tooltip.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(147, 112, 219, 0.75);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10002;
        animation: fadeIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(147, 112, 219, 0.4);
        border: 1px solid #9370DB;
    `;
        tooltip.textContent = message;
        document.body.appendChild(tooltip);
        return tooltip;
    }

    // 创建教程遮罩层
    function createTutorialOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'tutorial-overlay';
        overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        pointer-events: none;
        backdrop-filter: blur(2px);
    `;
        document.body.appendChild(overlay);
    }

    // 显示教程步骤
    function showTutorialStep(targetElement, title, description, duration) {
        return new Promise((resolve) => {
            const target = typeof targetElement === 'string'
                ? document.getElementById(targetElement) || document.querySelector(targetElement)
                : targetElement;

            if (!target) {
                resolve();
                return;
            }

            // 滚动到目标元素
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // 高亮目标元素
            const originalStyle = {
                position: target.style.position,
                zIndex: target.style.zIndex,
                boxShadow: target.style.boxShadow,
                borderRadius: target.style.borderRadius,
                backgroundColor: target.style.backgroundColor
            };

            target.style.position = 'relative';
            target.style.zIndex = '10000';
            target.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            target.style.borderRadius = '8px';
            target.style.backgroundColor = 'rgba(147, 112, 219, 0.1)';

            // 创建提示框（紫色主题）
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(147, 112, 219, 0.85);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(147, 112, 219, 0.4);
            max-width: 400px;
            z-index: 10001;
            text-align: center;
            animation: fadeIn 0.3s ease;
            border: 2px solid #9370DB;
        `;

            tooltip.innerHTML = `
            <h5 style="color: white; margin-bottom: 15px;">${title}</h5>
            <p style="margin-bottom: 20px; line-height: 1.6; color: #F8F8FF;">${description}</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="nextTutorialStep()" class="btn btn-light">继续 →</button>
                <button onclick="skipTutorial()" class="btn btn-outline-light">跳过教程</button>
            </div>
        `;

            document.body.appendChild(tooltip);

            window.nextTutorialStep = () => {
                // 恢复原始样式
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                resolve();
            };

            window.skipTutorial = () => {
                // 恢复原始样式
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                removeTutorialOverlay();
                alert('教程已跳过！您可以随时点击Guide按钮重新开始。');
            };

            // 自动继续
            if (duration) {
                setTimeout(() => {
                    if (document.body.contains(tooltip)) {
                        window.nextTutorialStep();
                    }
                }, duration);
            }
        });
    }

    // 移除教程遮罩层
    function removeTutorialOverlay() {
        const overlay = document.getElementById('tutorial-overlay');
        if (overlay) {
            overlay.remove();
        }
    }
</script>

<style>
    .guide-btn-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .guide-custom-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid #DDA0DD;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(147, 112, 219, 0.3);
        min-width: 200px;
        animation: fadeInUp 0.3s ease;
    }

    .guide-menu-item {
        padding: 12px 20px;
        color: #9370DB;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        border-radius: 8px;
        margin: 4px;
    }

    .guide-menu-item:hover {
        background: linear-gradient(135deg, rgba(147, 112, 219, 0.1), rgba(221, 160, 221, 0.1));
        color: #8A2BE2;
        transform: translateX(5px);
    }

    .guide-menu-item i {
        margin-right: 10px;
        font-size: 16px;
        width: 20px;
        text-align: center;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 确保云朵按钮在有菜单时的样式 */
    .guide-btn-cloud.active {
        transform: scale(1.05);
    }
    .stories-title {
        background: linear-gradient(135deg, #DDA0DD, #8A2BE2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
        font-size: 2.5rem;
        margin: 2rem 0;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
        background: linear-gradient(135deg, #4682B4, #4169E1);
        border: none;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #4169E1, #4682B4);
        transform: translateY(-2px);
    }

    .btn-outline-primary {
        color: #4169E1;
        border-color: #4169E1;
        transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #4169E1, #4682B4);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .stories-title {
            font-size: 1.8rem;
            margin: 1.5rem 0;
        }

        .story-cover-border {
            width: 80px !important;
            height: 60px !important;
            margin-right: 10px !important;
        }
    }
</style>
</body>
</html>