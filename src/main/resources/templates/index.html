<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Game Lobby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h2>Published Stories</h2>
    <div id="story-list" class="list-group">
        <!-- Stories will be loaded here by JavaScript -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchStories();
    });

    async function fetchStories() {
        const storyList = document.getElementById('story-list');
        try {
            const response = await fetch('/api/stories');
            if (!response.ok) {
                storyList.innerHTML = '<p class="text-danger">Failed to load stories. Server responded with an error.</p>';
                return;
            }
            const result = await response.json();
            if (result.code === '200' && result.data.length > 0) {
                storyList.innerHTML = ''; // Clear loading message
                result.data.forEach(story => {
                    const storyItem = document.createElement('a');
                    storyItem.href = `/play?storyId=${story.id}`;
                    storyItem.className = 'list-group-item list-group-item-action';
                    const coverHtml = story.cover ? `<img src="${story.cover}" style="max-width:120px;max-height:80px;margin-right:12px;"/>` : '';
                    storyItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                ${coverHtml}
                                <h5 class="mb-1">${story.name}</h5>
                            </div>
                            <small>By ${story.authorName || 'Unknown'}</small>
                        </div>
                        <p class="mb-1">${story.introduction || 'No introduction.'}</p>
                    `;
                    storyList.appendChild(storyItem);
                });
            } else if (result.code === '200') {
                storyList.innerHTML = '<p>No stories have been published yet. Why not create one?</p>';
            } else {
                 storyList.innerHTML = `<p class="text-danger">Error: ${result.msg || 'An unknown error occurred.'}</p>`;
            }
        } catch (error) {
            storyList.innerHTML = '<p class="text-danger">An unexpected error occurred while fetching stories.</p>';
        }
    }
</script>
</body>
</html>
