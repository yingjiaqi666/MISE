<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My Scenes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/music-player :: music-player}"></div>
<div class="container mt-4">
    <h1 class="mb-4">My Scenes</h1>
    <div id="scenes-container" class="card p-4">
        <p class="text-muted text-center">Loading your scenes...</p>
    </div>
</div>

<script>
    let scenesData = []; // 存储场景数据

    document.addEventListener('DOMContentLoaded', function() {
        // 检查是否是自动演示模式
        const urlParams = new URLSearchParams(window.location.search);
        const tutorialMode = urlParams.get('tutorial');

        loadScenes().then(() => {
            if (tutorialMode === 'auto') {
                // 延迟执行演示，确保页面完全加载
                setTimeout(() => {
                    executeMyScenesDemo();
                }, 2000);
            } else if (tutorialMode === 'continue') {
                // 继续场景连接演示
                const connectionIndex = parseInt(urlParams.get('connectionIndex')) || 0;
                setTimeout(() => {
                    continueSceneConnectionDemo(connectionIndex);
                }, 2000);
            }
        });
    });

    function loadScenes() {
        return fetch('/api/scenes/my-scenes')
            .then(response => response.json())
            .then(result => {
                const container = document.getElementById('scenes-container');
                if (!result) {
                    container.innerHTML = '<p class="text-danger">Failed to fetch scenes.</p>';
                    return;
                }
                if (result.code === '200') {
                    const scenes = result.data || [];
                    scenesData = scenes; // 保存场景数据

                    if (scenes.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted">You have not created any scenes yet.</p>';
                        return;
                    }
                    let html = '<ul class="list-group">';
                    scenes.forEach(s => {
                        html += `
                                <li id="scene-item-${s.id}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        ${s.picture ? `<img src="${s.picture}" class="story-cover-border" style="max-width:80px;max-height:60px;margin-right:12px;"/>` : ''}
                                        <a href="/scene-editor?sceneId=${s.id}" style="color: #9370DB; font-weight: 600;">${s.name}</a>
                                    </div>
                                    <div>
                                        <a class="btn btn-sm btn-outline-primary me-2" href="/scene-editor?sceneId=${s.id}">Edit</a>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScene(${s.id})">Delete</button>
                                    </div>
                                </li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;

                    // delete helper for scenes
                    window.deleteScene = function(sceneId) {
                        if (!confirm('确定要删除该场景吗？')) return;
                        fetch(`/api/scenes/${sceneId}`, { method: 'DELETE' })
                            .then(res => res.json())
                            .then(result => {
                                if (result && result.code === '200') {
                                    const el = document.getElementById('scene-item-' + sceneId);
                                    if (el) el.remove();
                                } else {
                                    alert('删除失败：' + (result ? result.msg : '未知错误'));
                                }
                            })
                            .catch(err => {
                                console.error('删除场景出错', err);
                                alert('删除场景时发生错误');
                            });
                    };
                } else {
                    container.innerHTML = `<p class="text-danger">Error: ${result.msg || 'Unknown'}</p>`;
                }
            })
            .catch(err => {
                console.error('Error fetching scenes:', err);
                document.getElementById('scenes-container').innerHTML = '<p class="text-danger">An unexpected error occurred while fetching your scenes.</p>';
            });
    }

    // My Scenes 自动演示函数
    async function executeMyScenesDemo() {
        // 创建遮罩层
        createTutorialOverlay();

        // 步骤1: 介绍My Scenes页面
        await showTutorialStepWithOverlay(
            '#scenes-container',
            '场景连接演示',
            '现在我们将演示如何连接场景。我将依次编辑每个场景，设置它们之间的连接关系。',
            3000
        );

        // 场景连接配置
        const sceneConnections = [
            { sceneName: 'party', nextScene: 'see', description: '将party场景连接到see场景' },
            { sceneName: 'see', nextScene: 'hole', description: '将see场景连接到hole场景' },
            { sceneName: 'hole', nextScene: 'world', description: '将hole场景连接到world场景' }
        ];

        // 依次处理每个场景连接
        for (let i = 0; i < sceneConnections.length; i++) {
            const connection = sceneConnections[i];

            // 找到对应的场景
            const currentScene = scenesData.find(s => s.name === connection.sceneName);
            if (!currentScene) {
                console.error(`找不到场景: ${connection.sceneName}`);
                continue;
            }

            // 步骤2: 高亮当前场景
            const sceneElement = document.querySelector(`#scene-item-${currentScene.id}`);
            if (sceneElement) {
                await showTutorialStep(
                    sceneElement,
                    `编辑${connection.sceneName}场景`,
                    connection.description,
                    2000
                );

                // 步骤3: 点击Edit按钮
                const editBtn = sceneElement.querySelector('.btn-outline-primary');
                if (editBtn) {
                    await showTutorialStep(
                        editBtn,
                        '点击编辑',
                        `点击"Edit"按钮编辑${connection.sceneName}场景`,
                        2000
                    );

                    // 显示跳转提示
                    await showTutorialStepWithOverlay(
                        sceneElement,
                        '跳转到场景编辑器',
                        `正在跳转到场景编辑器，设置${connection.sceneName}场景的连接...`,
                        2000
                    );

                    // 跳转到场景编辑器，带上连接信息
                    window.location.href = `/scene-editor?sceneId=${currentScene.id}&tutorial=connect&nextScene=${connection.nextScene}&returnToMyScenes=true&connectionIndex=${i}`;
                    return; // 跳转后停止当前执行
                }
            }
        }
    }

    // 继续场景连接演示
    async function continueSceneConnectionDemo(startIndex) {
        console.log(`继续场景连接演示，从索引 ${startIndex} 开始`);

        // 创建遮罩层
        createTutorialOverlay();

        // 场景连接配置
        const sceneConnections = [
            { sceneName: 'party', nextScene: 'see', description: '将party场景连接到see场景' },
            { sceneName: 'see', nextScene: 'hole', description: '将see场景连接到hole场景' },
            { sceneName: 'hole', nextScene: 'world', description: '将hole场景连接到world场景' }
        ];

        // 从指定索引开始继续演示
        if (startIndex < sceneConnections.length) {
            const connection = sceneConnections[startIndex];

            await showTutorialStepWithOverlay(
                '#scenes-container',
                `继续场景连接 (${startIndex + 1}/3)`,
                `现在设置${connection.description}`,
                3000
            );

            // 找到对应的场景
            const currentScene = scenesData.find(s => s.name === connection.sceneName);
            if (!currentScene) {
                console.error(`找不到场景: ${connection.sceneName}`);

                // 如果找不到场景，显示错误并结束演示
                await showTutorialStepWithOverlay(
                    '#scenes-container',
                    '场景未找到',
                    `无法找到名为"${connection.sceneName}"的场景。演示将结束。`,
                    3000
                );

                removeTutorialOverlay();
                return;
            }

            // 高亮当前场景并跳转编辑
            const sceneElement = document.querySelector(`#scene-item-${currentScene.id}`);
            if (sceneElement) {
                await showTutorialStep(
                    sceneElement,
                    `编辑${connection.sceneName}场景`,
                    connection.description,
                    2000
                );

                const editBtn = sceneElement.querySelector('.btn-outline-primary');
                if (editBtn) {
                    await showTutorialStep(
                        editBtn,
                        '点击编辑',
                        `点击"Edit"按钮编辑${connection.sceneName}场景`,
                        2000
                    );

                    await showTutorialStepWithOverlay(
                        sceneElement,
                        '跳转到场景编辑器',
                        `正在跳转到场景编辑器，设置${connection.sceneName}场景的连接...`,
                        2000
                    );

                    // 跳转到场景编辑器
                    removeTutorialOverlay();
                    window.location.href = `/scene-editor?sceneId=${currentScene.id}&tutorial=connect&nextScene=${connection.nextScene}&returnToMyScenes=true&connectionIndex=${startIndex}`;
                    return;
                }
            }
        } else {
            // 所有连接都完成了，自动跳转到Create Story演示
            await showTutorialStepWithOverlay(
                '#scenes-container',
                '所有场景连接完成',
                '恭喜！所有场景连接都已设置完成。现在我们将演示如何创建完整的故事！',
                3000
            );

            await showTutorialStepWithOverlay(
                '#scenes-container',
                '跳转到故事创建',
                '正在跳转到Story Editor页面，演示如何创建完整的交互式故事...',
                2000
            );

            removeTutorialOverlay();

            // 自动跳转到Create Story演示
            window.location.href = '/story-editor?tutorial=auto';
        }
    }

    // 简单的蒙版提示（只显示蒙版和中央文字）
    function showTutorialStepWithOverlay(targetElement, title, description, duration) {
        return new Promise((resolve) => {
            // 创建中央提示框（在现有蒙版上显示）
            const centerTooltip = document.createElement('div');
            centerTooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(147, 112, 219, 0.85);
                color: white;
                padding: 25px 35px;
                border-radius: 12px;
                font-weight: bold;
                z-index: 10001;
                text-align: center;
                animation: fadeIn 0.3s ease;
                box-shadow: 0 8px 32px rgba(147, 112, 219, 0.4);
                border: 2px solid #9370DB;
                min-width: 300px;
                backdrop-filter: blur(10px);
            `;

            centerTooltip.innerHTML = `
                <h5 style="color: white; margin-bottom: 15px; font-size: 1.3rem;">${title}</h5>
                <p style="margin: 0; line-height: 1.6; color: #F8F8FF; font-size: 1.1rem;">${description}</p>
            `;

            document.body.appendChild(centerTooltip);

            // 自动移除提示框
            setTimeout(() => {
                if (centerTooltip && centerTooltip.parentNode) {
                    centerTooltip.remove();
                }

                resolve();
            }, duration);
        });
    }

    // 创建教程遮罩层
    function createTutorialOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'tutorial-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(2px);
        `;
        document.body.appendChild(overlay);
    }

    // 显示教程步骤
    function showTutorialStep(targetElement, title, description, duration) {
        return new Promise((resolve) => {
            const target = typeof targetElement === 'string'
                ? document.getElementById(targetElement) || document.querySelector(targetElement)
                : targetElement;

            if (!target) {
                resolve();
                return;
            }

            // 滚动到目标元素
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // 高亮目标元素
            const originalStyle = {
                position: target.style.position,
                zIndex: target.style.zIndex,
                boxShadow: target.style.boxShadow,
                borderRadius: target.style.borderRadius,
                backgroundColor: target.style.backgroundColor
            };

            target.style.position = 'relative';
            target.style.zIndex = '10000';
            target.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            target.style.borderRadius = '8px';
            target.style.backgroundColor = 'rgba(147, 112, 219, 0.1)';

            // 创建提示框（紫色主题）
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(147, 112, 219, 0.85);
                color: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(147, 112, 219, 0.4);
                max-width: 400px;
                z-index: 10001;
                text-align: center;
                animation: fadeIn 0.3s ease;
                border: 2px solid #9370DB;
                backdrop-filter: blur(10px);
            `;

            tooltip.innerHTML = `
                <h5 style="color: white; margin-bottom: 15px;">${title}</h5>
                <p style="margin-bottom: 20px; line-height: 1.6; color: #F8F8FF;">${description}</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="nextTutorialStep()" class="btn btn-light">继续 →</button>
                    <button onclick="skipTutorial()" class="btn btn-outline-light">跳过教程</button>
                </div>
            `;

            document.body.appendChild(tooltip);

            window.nextTutorialStep = () => {
                // 恢复原始样式
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                resolve();
            };

            window.skipTutorial = () => {
                // 恢复原始样式
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                removeTutorialOverlay();
                alert('教程已跳过！');
            };

            // 自动继续
            if (duration) {
                setTimeout(() => {
                    if (document.body.contains(tooltip)) {
                        window.nextTutorialStep();
                    }
                }, duration);
            }
        });
    }

    // 移除教程遮罩层
    function removeTutorialOverlay() {
        const overlay = document.getElementById('tutorial-overlay');
        if (overlay) {
            overlay.remove();
        }
    }
</script>
</body>
</html>