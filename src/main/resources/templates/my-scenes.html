<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My Scenes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
    <h1 class="mb-4">My Scenes</h1>
    <div id="scenes-container" class="card p-4">
        <p class="text-muted text-center">Loading your scenes...</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/scenes/my-scenes')
            .then(response => response.json())
            .then(result => {
                const container = document.getElementById('scenes-container');
                if (!result) {
                    container.innerHTML = '<p class="text-danger">Failed to fetch scenes.</p>';
                    return;
                }
                if (result.code === '200') {
                    const scenes = result.data || [];
                    if (scenes.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted">You have not created any scenes yet.</p>';
                        return;
                    }
                    let html = '<ul class="list-group">';
                    scenes.forEach(s => {
                        html += `
                                <li id="scene-item-${s.id}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        ${s.picture ? `<img src="${s.picture}" class="story-cover-border" style="max-width:80px;max-height:60px;margin-right:12px;"/>` : ''}
                                        <a href="/scene-editor?sceneId=${s.id}" style="color: #9370DB; font-weight: 600;">${s.name}</a>
                                    </div>
                                    <div>
                                        <a class="btn btn-sm btn-outline-primary me-2" href="/scene-editor?sceneId=${s.id}">Edit</a>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScene(${s.id})">Delete</button>
                                    </div>
                                </li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;

                    // delete helper for scenes
                    window.deleteScene = function(sceneId) {
                        if (!confirm('确定要删除该场景吗？')) return;
                        fetch(`/api/scenes/${sceneId}`, { method: 'DELETE' })
                            .then(res => res.json())
                            .then(result => {
                                if (result && result.code === '200') {
                                    const el = document.getElementById('scene-item-' + sceneId);
                                    if (el) el.remove();
                                } else {
                                    alert('删除失败：' + (result ? result.msg : '未知错误'));
                                }
                            })
                            .catch(err => {
                                console.error('删除场景出错', err);
                                alert('删除场景时发生错误');
                            });
                    };
                } else {
                    container.innerHTML = `<p class="text-danger">Error: ${result.msg || 'Unknown'}</p>`;
                }
            })
            .catch(err => {
                console.error('Error fetching scenes:', err);
                document.getElementById('scenes-container').innerHTML = '<p class="text-danger">An unexpected error occurred while fetching your scenes.</p>';
            });
    });
</script>
</body>
</html>