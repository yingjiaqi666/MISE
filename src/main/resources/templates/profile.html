<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/music-player :: music-player}"></div>
<div class="container mt-4">
    <h2 class="mb-4">My Profile</h2>

    <div id="profile-info" class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">User Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p><strong>Username:</strong> <span id="username" class="text-purple"></span></p>
                    <p><strong>Name:</strong> <span id="name" class="text-purple"></span></p>
                    <p><strong>Available Points:</strong> <span id="points" class="fw-bold text-primary fs-5"></span></p>
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Attributes</h5>
            <form id="attributes-form">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Power <span id="power-val" class="fw-bold text-purple"></span></label>
                        <input type="number" id="power" class="form-control" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Agile <span id="agile-val" class="fw-bold text-purple"></span></label>
                        <input type="number" id="agile" class="form-control" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Perception <span id="perception-val" class="fw-bold text-purple"></span></label>
                        <input type="number" id="perception" class="form-control" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Intelligence <span id="intelligence-val" class="fw-bold text-purple"></span></label>
                        <input type="number" id="intelligence" class="form-control" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Charm <span id="charm-val" class="fw-bold text-purple"></span></label>
                        <input type="number" id="charm" class="form-control" min="0">
                    </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">Update Attributes</button>
                    <button type="button" id="reset-attributes-btn" class="btn btn-warning">Reset Attributes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="card-title mb-0">My Products</h4>
                </div>
                <div class="card-body">
                    <div id="my-products" class="list-group" style="border: none;">
                        <p class="text-muted text-center">Loading products...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="card-title mb-0">My Stories</h4>
                </div>
                <div class="card-body">
                    <div id="my-stories" class="list-group" style="border: none;">
                        <p class="text-muted text-center">Loading stories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let originalAttributes = {};

    document.addEventListener('DOMContentLoaded', function () {
        fetchProfile();
        fetchMyStories();
    });

    async function fetchProfile() {
        try {
            const response = await fetch('/api/accounts/profile');
            const result = await response.json();
            if (result.code === '200') {
                const user = result.data;
                originalAttributes = { ...user }; // Store original state

                // Update user info
                document.getElementById('username').textContent = user.username;
                document.getElementById('name').textContent = user.name || 'Not set';
                document.getElementById('points').textContent = user.points;

                // Update attribute inputs and values
                const attributes = ['power', 'agile', 'perception', 'intelligence', 'charm'];
                attributes.forEach(attr => {
                    const input = document.getElementById(attr);
                    const valueSpan = document.getElementById(attr + '-val');
                    if (input && valueSpan) {
                        input.value = user[attr] || 0;
                        valueSpan.textContent = `(${user[attr] || 0})`;
                    }
                });

                // Display products
                const productList = document.getElementById('my-products');
                productList.innerHTML = '';
                if (user.products && user.products.length > 0) {
                    user.products.forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.className = 'list-group-item mb-2';
                        productItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="text-purple">${product.name}</strong>
                                    <p class="mb-0 text-muted" style="font-size: 0.9rem;">${product.description || 'No description'}</p>
                                </div>
                            </div>
                        `;
                        productList.appendChild(productItem);
                    });
                } else {
                    productList.innerHTML = '<p class="text-center text-muted">You have no products.</p>';
                }

            } else {
                document.getElementById('profile-info').innerHTML = `<p class="text-danger">Error: ${result.msg}</p>`;
            }
        } catch (error) {
            document.getElementById('profile-info').innerHTML = '<p class="text-danger">Failed to load profile.</p>';
        }
    }

    document.getElementById('attributes-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const updatedData = {
            power: parseInt(document.getElementById('power').value) || 0,
            agile: parseInt(document.getElementById('agile').value) || 0,
            perception: parseInt(document.getElementById('perception').value) || 0,
            intelligence: parseInt(document.getElementById('intelligence').value) || 0,
            charm: parseInt(document.getElementById('charm').value) || 0,
        };

        try {
            const response = await fetch('/api/accounts/profile/attributes', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            const result = await response.json();
            if(result.code === '200') {
                alert(result.msg || 'Attributes updated successfully!');
                fetchProfile(); // Refresh profile data
            } else {
                alert(result.msg || 'Failed to update attributes.');
            }
        } catch (error) {
            alert('An error occurred while updating attributes.');
        }
    });

    document.getElementById('reset-attributes-btn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to reset your attributes? All points will be refunded.')) return;

        try {
            const response = await fetch('/api/accounts/profile/reset-attributes', { method: 'POST' });
            const result = await response.json();
            if(result.code === '200') {
                alert(result.msg || 'Attributes reset successfully!');
                fetchProfile(); // Refresh profile data
            } else {
                alert(result.msg || 'Failed to reset attributes.');
            }
        } catch (error) {
            alert('An error occurred while resetting attributes.');
        }
    });

    async function fetchMyStories() {
        const storyList = document.getElementById('my-stories');
        try {
            const response = await fetch('/api/stories/my-stories');
            const result = await response.json();
            if (result.code === '200' && result.data.length > 0) {
                storyList.innerHTML = '';
                result.data.forEach(story => {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'list-group-item mb-2';
                    const coverHtml = story.cover ? `<img src="${story.cover}" class="story-cover-border" style="max-width:80px;max-height:60px;margin-right:12px;"/>` : '';
                    storyItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                ${coverHtml}
                                <div>
                                    <h6 class="mb-0 text-purple">${story.name}</h6>
                                    <p class="mb-0 text-muted" style="font-size: 0.85rem;">${story.introduction?.substring(0, 50) || 'No introduction'}${story.introduction?.length > 50 ? '...' : ''}</p>
                                </div>
                            </div>
                            <a href="/story-editor?storyId=${story.id}" class="btn btn-sm btn-outline-primary">Edit</a>
                        </div>
                    `;
                    storyList.appendChild(storyItem);
                });
            } else if (result.code === '200') {
                storyList.innerHTML = '<p class="text-center text-muted">You have not created any stories yet.</p>';
            } else {
                storyList.innerHTML = `<p class="text-danger">Error: ${result.msg}</p>`;
            }
        } catch (error) {
            storyList.innerHTML = '<p class="text-danger">Failed to load your stories.</p>';
        }
    }
</script>

<style>
    .text-purple {
        color: #9370DB !important;
    }
</style>
</body>
</html>