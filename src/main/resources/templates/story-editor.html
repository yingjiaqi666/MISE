<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Story Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/music-player :: music-player}"></div>

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2 id="editor-title" class="mb-0">Create New Story</h2>
        </div>
        <div class="card-body">
            <div id="message" class="alert" style="display:none;"></div>

            <!-- Story Details Form -->
            <form id="story-form">
                <input type="hidden" id="storyId" name="storyId">

                <div class="mb-4">
                    <h5 class="text-purple mb-3">Story Information</h5>
                    <div class="mb-3">
                        <label for="name" class="form-label fw-bold">Story Name</label>
                        <input type="text" class="form-control" id="name" required placeholder="Enter story name...">
                    </div>
                    <div class="mb-3">
                        <label for="introduction" class="form-label fw-bold">Introduction</label>
                        <textarea class="form-control" id="introduction" rows="3" placeholder="Enter story introduction..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cover Image</label>
                        <input type="hidden" id="cover">
                        <div class="input-group mb-2">
                            <input type="file" id="coverFile" accept="image/*" class="form-control">
                        </div>
                        <div id="cover-preview-container" class="text-center" style="display: none;">
                            <img id="coverPreview" src="" alt="preview" class="story-cover-border" style="max-width: 240px; max-height: 160px;"/>
                        </div>
                        <div class="form-text text-muted">选择图片后会自动上传，并把图片地址保存到该故事</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="max" class="form-label fw-bold">Max Players</label>
                            <input type="number" class="form-control" id="max" value="1" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="firstSceneSelect" class="form-label fw-bold">Starting Scene</label>
                            <select id="firstSceneSelect" class="form-select">
                                <option value="">-- Choose a scene --</option>
                            </select>
                            <div class="form-text">Choose one of your scenes to start the story</div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/my-stories'">
                        Back to My Stories
                    </button>
                    <button type="submit" class="btn btn-primary px-4">Save Story Details</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const storyIdInput = document.getElementById('storyId');
    const messageDiv = document.getElementById('message');
    let currentStoryId = null;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');
        // Load user's scenes for selection of starting scene
        loadUserScenes();
        if (storyId) {
            currentStoryId = storyId;
            loadStoryForEditing(storyId);
        }
    });

    // auto upload when selecting file
    document.getElementById('coverFile').addEventListener('change', async function() {
        const input = this;
        if (!input.files || !input.files[0]) return;
        try {
            const url = await uploadImage(input.files[0]);
            document.getElementById('cover').value = url;
            const pv = document.getElementById('coverPreview');
            pv.src = url;
            document.getElementById('cover-preview-container').style.display = 'block';
        } catch (e) {
            showMessage('图片上传失败: ' + (e && e.message ? e.message : e), false);
        } finally {
            input.value = '';
        }
    });

    // Handle Story Form (Create/Update)
    document.getElementById('story-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const storyData = {
            name: document.getElementById('name').value,
            introduction: document.getElementById('introduction').value,
            cover: document.getElementById('cover').value,
            max: parseInt(document.getElementById('max').value, 10),
            firstSceneId: document.getElementById('firstSceneSelect').value ? parseInt(document.getElementById('firstSceneSelect').value, 10) : null
        };

        const isUpdate = !!currentStoryId;
        const url = isUpdate ? `/api/stories/${currentStoryId}` : '/api/stories/create';
        const method = isUpdate ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(storyData)
            });
            const result = await response.json();
            const isSuccess = result && result.code === '200';
            showMessage(result ? (result.msg || (isSuccess ? 'Story saved successfully!' : 'An error occurred.')) : 'Unexpected response', isSuccess);

            if (isSuccess && !isUpdate) {
                window.location.search = `?storyId=${result.data}`;
            } else if (isSuccess) {
                // Refresh the page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        } catch (error) {
            showMessage('An unexpected error occurred.', false);
        }
    });

    async function loadStoryForEditing(storyId) {
        try {
            const response = await fetch(`/api/stories/${storyId}`);
            const result = await response.json();
            if (result && result.code === '200') {
                const story = result.data;
                document.getElementById('editor-title').textContent = `Editing: ${story.name}`;
                storyIdInput.value = story.id;
                document.getElementById('name').value = story.name;
                document.getElementById('introduction').value = story.introduction;
                document.getElementById('cover').value = story.cover || '';
                if (story.cover) {
                    const pv = document.getElementById('coverPreview');
                    pv.src = story.cover;
                    document.getElementById('cover-preview-container').style.display = 'block';
                }
                document.getElementById('max').value = story.max;
                // Pre-select first scene if present
                if (story.firstSceneId) {
                    const sel = document.getElementById('firstSceneSelect');
                    sel.value = story.firstSceneId;
                }
            } else {
                showMessage(result ? result.msg : 'Failed to load story details.', false);
            }
        } catch (error) {
            showMessage('Failed to load story details.', false);
        }
    }

    async function loadUserScenes() {
        try {
            const res = await fetch('/api/scenes/my-scenes');
            const result = await res.json();
            if (result && result.code === '200') {
                const select = document.getElementById('firstSceneSelect');
                // keep existing default option
                result.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.name} (id:${s.id})`;
                    select.appendChild(opt);
                });
            }
        } catch (err) {
            console.warn('无法加载用户场景列表', err);
        }
    }

    function showMessage(msg, isSuccess) {
        messageDiv.textContent = msg;
        messageDiv.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
    }

    async function uploadImage(file) {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        let parsed = null;
        try {
            parsed = await res.clone().json();
        } catch (e) {
            const txt = await res.clone().text();
            throw new Error(`非JSON响应 (HTTP ${res.status}): ${txt.slice(0,200)}`);
        }
        if (!res.ok) {
            const msg = (parsed && parsed.msg) ? parsed.msg : `HTTP ${res.status} ${res.statusText}`;
            throw new Error(msg);
        }
        if (parsed && parsed.code === '200') {
            const data = parsed.data;
            return (data && (data.url || data)) || '';
        }
        throw new Error(parsed ? (parsed.msg || '上传返回失败') : 'upload failed');
    }
</script>

<style>
    .text-purple {
        color: #9370DB !important;
    }
</style>
</body>
</html>