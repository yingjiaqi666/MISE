<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Story Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="starry-background">
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/music-player :: music-player}"></div>

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2 id="editor-title" class="mb-0">Create New Story</h2>
        </div>
        <div class="card-body">
            <div id="message" class="alert" style="display:none;"></div>

            <!-- Story Details Form -->
            <form id="story-form">
                <input type="hidden" id="storyId" name="storyId">

                <div class="mb-4">
                    <h5 class="text-purple mb-3">Story Information</h5>
                    <div class="mb-3">
                        <label for="name" class="form-label fw-bold">Story Name</label>
                        <input type="text" class="form-control" id="name" required placeholder="Enter story name...">
                    </div>
                    <div class="mb-3">
                        <label for="introduction" class="form-label fw-bold">Introduction</label>
                        <textarea class="form-control" id="introduction" rows="3" placeholder="Enter story introduction..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cover Image</label>
                        <input type="hidden" id="cover">
                        <div class="input-group mb-2">
                            <input type="file" id="coverFile" accept="image/*" class="form-control">
                        </div>
                        <div id="cover-preview-container" class="text-center" style="display: none;">
                            <img id="coverPreview" src="" alt="preview" class="story-cover-border" style="max-width: 240px; max-height: 160px;"/>
                        </div>
                        <div class="form-text text-muted">é€‰æ‹©å›¾ç‰‡åä¼šè‡ªåŠ¨ä¸Šä¼ ï¼Œå¹¶æŠŠå›¾ç‰‡åœ°å€ä¿å­˜åˆ°è¯¥æ•…äº‹</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="max" class="form-label fw-bold">Max Players</label>
                            <input type="number" class="form-control" id="max" value="1" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="firstSceneSelect" class="form-label fw-bold">Starting Scene</label>
                            <select id="firstSceneSelect" class="form-select">
                                <option value="">-- Choose a scene --</option>
                            </select>
                            <div class="form-text">Choose one of your scenes to start the story</div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/my-stories'">
                        Back to My Stories
                    </button>
                    <button type="submit" class="btn btn-primary px-4">Save Story Details</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const storyIdInput = document.getElementById('storyId');
    const messageDiv = document.getElementById('message');
    let currentStoryId = null;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');
        const tutorialMode = urlParams.get('tutorial');

        // Load user's scenes for selection of starting scene
        loadUserScenes().then(() => {
            if (storyId) {
                currentStoryId = storyId;
                loadStoryForEditing(storyId);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼
            if (tutorialMode === 'auto') {
                setTimeout(() => {
                    executeCreateStoryDemo();
                }, 2000);
            }
        });

        // åœ¨æ¼”ç¤ºæ¨¡å¼ä¸‹é˜»æ­¢è¡¨å•æäº¤
        const form = document.getElementById('story-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const tutorialMode = urlParams.get('tutorial');

                // å¦‚æœæ˜¯æ¼”ç¤ºæ¨¡å¼ï¼Œä½†ä¸æ˜¯é€šè¿‡ simulateStorySave è§¦å‘çš„ï¼Œåˆ™é˜»æ­¢
                if (tutorialMode === 'auto' && !window.isDemoSaving) {
                    console.log('æ¼”ç¤ºæ¨¡å¼ï¼šé˜»æ­¢éæ¼”ç¤ºä¿å­˜çš„è¡¨å•æäº¤');
                    e.preventDefault();
                    return false;
                }
            });
        }
    });

    // Create Story è‡ªåŠ¨æ¼”ç¤ºå‡½æ•°
    async function executeCreateStoryDemo() {
        // åˆ›å»ºé®ç½©å±‚
        createTutorialOverlay();

        // æ­¥éª¤1: ä»‹ç»Create Storyé¡µé¢
        await showTutorialStepWithOverlay(
            '.card',
            'åˆ›å»ºæ•…äº‹æ¼”ç¤º',
            'ç°åœ¨æˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æ•…äº‹ã€‚æˆ‘å°†å¡«å†™æ•…äº‹ä¿¡æ¯ã€ä¸Šä¼ å°é¢å›¾ç‰‡å¹¶è®¾ç½®èµ·å§‹åœºæ™¯ã€‚',
            3000
        );

        // æ­¥éª¤2: å¡«å†™æ•…äº‹åç§°
        await showTutorialStep(
            '#name',
            'æ•…äº‹åç§°',
            'è®¾ç½®æ•…äº‹åç§°ä¸ºï¼š"Alice\'s Adventures in Wonderland"',
            2000
        );
        await simulateInput(document.getElementById('name'), "Alice's Adventures in Wonderland");

        // æ­¥éª¤3: å¡«å†™æ•…äº‹ä»‹ç»
        await showTutorialStep(
            '#introduction',
            'æ•…äº‹ä»‹ç»',
            'å¡«å†™æ•…äº‹çš„è¯¦ç»†ä»‹ç»',
            2000
        );
        const introduction = "Alice Wonderland Adventures tells the little girl Alice to catch a Chuaizhuo pocket watch speak the white rabbit, fell into a rabbit hole, which fell into the magical underground world.";
        await simulateInput(document.getElementById('introduction'), introduction);

        // æ­¥éª¤4: ä¸Šä¼ å°é¢å›¾ç‰‡
        await showTutorialStep(
            '#coverFile',
            'å°é¢å›¾ç‰‡',
            'ä¸Šä¼ æ•…äº‹å°é¢å›¾ç‰‡ï¼š5.png',
            2000
        );
        await simulateImageUpload('5.png');

        // æ­¥éª¤5: é€‰æ‹©èµ·å§‹åœºæ™¯
        await showTutorialStep(
            '#firstSceneSelect',
            'èµ·å§‹åœºæ™¯',
            'é€‰æ‹©"party"ä½œä¸ºæ•…äº‹çš„èµ·å§‹åœºæ™¯',
            2000
        );
        await simulateSelectOption(document.getElementById('firstSceneSelect'), 'party');

        // æ­¥éª¤6: ä¿å­˜æ•…äº‹
        const saveBtn = document.querySelector('button[type="submit"]');
        await showTutorialStep(
            saveBtn,
            'ä¿å­˜æ•…äº‹',
            'ç‚¹å‡»"Save Story Details"ä¿å­˜æ•…äº‹ä¿¡æ¯',
            2000
        );

        await simulateStorySave(saveBtn, 'æ­£åœ¨ä¿å­˜æ•…äº‹...');

        // ç­‰å¾…ä¿å­˜å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 1000));

        // æ¼”ç¤ºå®Œæˆ
        await showTutorialStepWithOverlay(
            '.card',
            'å®Œæ•´æ¼”ç¤ºç»“æŸ',
            'ğŸ‰ æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†å®Œæ•´çš„äº¤äº’å¼æ•…äº‹åˆ›å»ºæµç¨‹ï¼\n\nä»åœºæ™¯åˆ›å»º â†’ åœºæ™¯è¿æ¥ â†’ æ•…äº‹åˆ›å»ºï¼Œæ‚¨ç°åœ¨å·²ç»æŒæ¡äº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚',
            4000
        );

        await showTutorialStepWithOverlay(
            '.card',
            'æ¼”ç¤ºæ€»ç»“',
            'âœ… åˆ›å»ºäº†4ä¸ªåœºæ™¯\nâœ… è®¾ç½®äº†åœºæ™¯é—´çš„è¿æ¥\nâœ… åˆ›å»ºäº†å®Œæ•´çš„æ•…äº‹\n\nç°åœ¨æ‚¨å¯ä»¥å¼€å§‹åˆ›å»ºè‡ªå·±çš„äº¤äº’å¼æ•…äº‹äº†ï¼',
            4000
        );

        removeTutorialOverlay();

        // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æŸ¥çœ‹åˆ›å»ºçš„æ•…äº‹
        const viewStory = confirm('æ¼”ç¤ºå®Œæˆï¼æ˜¯å¦è¦æŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„æ•…äº‹ï¼Ÿ');
        if (viewStory) {
            // è·³è½¬åˆ°My Storiesé¡µé¢ï¼Œå¸¦ä¸Šæ¼”ç¤ºæ ‡è®°ä»¥ä¾¿æ˜¾ç¤ºåˆšåˆ›å»ºçš„æ•…äº‹
            window.location.href = '/my-stories?from=demo';
        } else {
            alert('æ„Ÿè°¢æ‚¨å®Œæˆæ–°æ‰‹æ•™ç¨‹ï¼æ‚¨ç°åœ¨å¯ä»¥å¼€å§‹åˆ›å»ºè‡ªå·±çš„äº¤äº’å¼æ•…äº‹äº†ã€‚');
        }
    }
    // æ¨¡æ‹Ÿè¾“å…¥æ–‡æœ¬
    function simulateInput(element, text) {
        return new Promise((resolve) => {
            // é«˜äº®å…ƒç´ 
            element.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            element.style.backgroundColor = 'rgba(147, 112, 219, 0.2)';

            // æ˜¾ç¤ºæ“ä½œæç¤º
            const tooltip = createOperationTooltip(`æ­£åœ¨è¾“å…¥: ${text.substring(0, 30)}...`);

            setTimeout(() => {
                // æ¨¡æ‹Ÿé€å­—è¾“å…¥
                let currentText = '';
                const inputInterval = setInterval(() => {
                    if (currentText.length < text.length) {
                        currentText += text[currentText.length];
                        element.value = currentText;
                        element.dispatchEvent(new Event('input', { bubbles: true }));
                    } else {
                        clearInterval(inputInterval);

                        // æ¢å¤æ ·å¼
                        element.style.boxShadow = '';
                        element.style.backgroundColor = '';

                        // ç§»é™¤æç¤º
                        if (tooltip && tooltip.parentNode) {
                            tooltip.remove();
                        }

                        resolve();
                    }
                }, 50); // æ¯50msè¾“å…¥ä¸€ä¸ªå­—ç¬¦
            }, 500);
        });
    }

    // æ¨¡æ‹Ÿå›¾ç‰‡ä¸Šä¼ 
    function simulateImageUpload(imageName) {
        return new Promise((resolve) => {
            const fileInput = document.getElementById('coverFile');

            // é«˜äº®æ–‡ä»¶è¾“å…¥æ¡†
            fileInput.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            fileInput.style.backgroundColor = 'rgba(147, 112, 219, 0.2)';

            // æ˜¾ç¤ºæ“ä½œæç¤º
            const tooltip = createOperationTooltip(`æ­£åœ¨ä¸Šä¼ å°é¢å›¾ç‰‡ï¼š${imageName}`);

            setTimeout(() => {
                // æ¨¡æ‹Ÿå›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè®¾ç½®å›¾ç‰‡URL
                const imageUrl = `/images/landscape/${imageName}`;
                document.getElementById('cover').value = imageUrl;

                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('coverPreview');
                preview.src = imageUrl;
                document.getElementById('cover-preview-container').style.display = 'block';

                // æ¢å¤æ ·å¼
                fileInput.style.boxShadow = '';
                fileInput.style.backgroundColor = '';

                // ç§»é™¤æç¤º
                if (tooltip && tooltip.parentNode) {
                    tooltip.remove();
                }

                resolve();
            }, 2000);
        });
    }

    // æ¨¡æ‹Ÿé€‰æ‹©ä¸‹æ‹‰æ¡†é€‰é¡¹
    function simulateSelectOption(selectElement, optionText) {
        return new Promise((resolve) => {
            // é«˜äº®å…ƒç´ 
            selectElement.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            selectElement.style.backgroundColor = 'rgba(147, 112, 219, 0.2)';

            // æ˜¾ç¤ºæ“ä½œæç¤º
            const tooltip = createOperationTooltip(`æ­£åœ¨é€‰æ‹©${optionText}åœºæ™¯...`);

            setTimeout(() => {
                // æŸ¥æ‰¾å¹¶é€‰æ‹©å¯¹åº”çš„é€‰é¡¹
                const options = selectElement.querySelectorAll('option');
                for (let option of options) {
                    if (option.textContent.toLowerCase().includes(optionText.toLowerCase())) {
                        selectElement.value = option.value;
                        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                        break;
                    }
                }

                // æ¢å¤æ ·å¼
                selectElement.style.boxShadow = '';
                selectElement.style.backgroundColor = '';

                // ç§»é™¤æç¤º
                if (tooltip && tooltip.parentNode) {
                    tooltip.remove();
                }

                resolve();
            }, 1500);
        });
    }

    // ä¿®æ”¹åçš„æ¨¡æ‹Ÿæ•…äº‹ä¿å­˜å‡½æ•° - å®é™…æ‰§è¡Œä¿å­˜æ“ä½œ
    function simulateStorySave(element, message) {
        return new Promise(async (resolve) => {
            // æ˜¾ç¤ºæ“ä½œæç¤º
            const tooltip = createOperationTooltip(message);

            // é«˜äº®å…ƒç´ 
            element.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            element.style.backgroundColor = 'rgba(147, 112, 219, 0.2)';

            setTimeout(async () => {
                try {
                    // æ”¶é›†æ•…äº‹æ•°æ®
                    const storyData = {
                        name: document.getElementById('name').value,
                        introduction: document.getElementById('introduction').value,
                        cover: document.getElementById('cover').value,
                        max: parseInt(document.getElementById('max').value, 10),
                        firstSceneId: document.getElementById('firstSceneSelect').value ?
                            parseInt(document.getElementById('firstSceneSelect').value, 10) : null
                    };

                    console.log('æ­£åœ¨ä¿å­˜æ•…äº‹æ•°æ®:', storyData);

                    // å®é™…æäº¤æ•…äº‹æ•°æ®
                    const isUpdate = !!currentStoryId;
                    const url = isUpdate ? `/api/stories/${currentStoryId}` : '/api/stories/create';
                    const method = isUpdate ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(storyData)
                    });

                    const result = await response.json();
                    console.log('æ•…äº‹ä¿å­˜ç»“æœ:', result);

                    if (result && result.code === '200') {
                        console.log('æ•…äº‹ä¿å­˜æˆåŠŸï¼');

                        // å¦‚æœæ˜¯æ–°åˆ›å»ºçš„æ•…äº‹ï¼Œæ›´æ–°å½“å‰æ•…äº‹ID
                        if (!isUpdate && result.data) {
                            currentStoryId = result.data;
                            document.getElementById('storyId').value = result.data;
                        }

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showMessage('Story saved successfully!', true);
                    } else {
                        console.error('æ•…äº‹ä¿å­˜å¤±è´¥:', result ? result.msg : 'Unknown error');
                        showMessage('Failed to save story: ' + (result ? result.msg : 'Unknown error'), false);
                    }

                } catch (error) {
                    console.error('ä¿å­˜æ•…äº‹æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    showMessage('An error occurred while saving the story.', false);
                }

                // æ¢å¤æ ·å¼
                element.style.boxShadow = '';
                element.style.backgroundColor = '';

                // ç§»é™¤æç¤º
                if (tooltip && tooltip.parentNode) {
                    tooltip.remove();
                }

                resolve();
            }, 2000);
        });
    }
    // åˆ›å»ºæ“ä½œæç¤ºæ¡†
    function createOperationTooltip(message) {
        const tooltip = document.createElement('div');
        tooltip.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(147, 112, 219, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10002;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(147, 112, 219, 0.4);
            border: 1px solid #9370DB;
            backdrop-filter: blur(10px);
        `;
        tooltip.textContent = message;
        document.body.appendChild(tooltip);
        return tooltip;
    }

    // å¸¦æœ‰è’™ç‰ˆæ•ˆæœçš„æ•™ç¨‹æ­¥éª¤æ˜¾ç¤º
    function showTutorialStepWithOverlay(targetElement, title, description, duration) {
        return new Promise((resolve) => {
            // åˆ›å»ºä¸­å¤®æç¤ºæ¡†ï¼ˆåœ¨ç°æœ‰è’™ç‰ˆä¸Šæ˜¾ç¤ºï¼‰
            const centerTooltip = document.createElement('div');
            centerTooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(147, 112, 219, 0.85);
                color: white;
                padding: 25px 35px;
                border-radius: 12px;
                font-weight: bold;
                z-index: 10001;
                text-align: center;
                animation: fadeIn 0.3s ease;
                box-shadow: 0 8px 32px rgba(147, 112, 219, 0.4);
                border: 2px solid #9370DB;
                min-width: 300px;
                backdrop-filter: blur(10px);
            `;

            centerTooltip.innerHTML = `
                <h5 style="color: white; margin-bottom: 15px; font-size: 1.3rem;">${title}</h5>
                <p style="margin: 0; line-height: 1.6; color: #F8F8FF; font-size: 1.1rem;">${description}</p>
            `;

            document.body.appendChild(centerTooltip);

            // è‡ªåŠ¨ç§»é™¤æç¤ºæ¡†
            setTimeout(() => {
                if (centerTooltip && centerTooltip.parentNode) {
                    centerTooltip.remove();
                }

                resolve();
            }, duration);
        });
    }

    // åˆ›å»ºæ•™ç¨‹é®ç½©å±‚
    function createTutorialOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'tutorial-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(2px);
        `;
        document.body.appendChild(overlay);
    }

    // æ˜¾ç¤ºæ•™ç¨‹æ­¥éª¤
    function showTutorialStep(targetElement, title, description, duration) {
        return new Promise((resolve) => {
            const target = typeof targetElement === 'string'
                ? document.getElementById(targetElement) || document.querySelector(targetElement)
                : targetElement;

            if (!target) {
                resolve();
                return;
            }

            // æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // é«˜äº®ç›®æ ‡å…ƒç´ 
            const originalStyle = {
                position: target.style.position,
                zIndex: target.style.zIndex,
                boxShadow: target.style.boxShadow,
                borderRadius: target.style.borderRadius,
                backgroundColor: target.style.backgroundColor
            };

            target.style.position = 'relative';
            target.style.zIndex = '10000';
            target.style.boxShadow = '0 0 20px 5px rgba(147, 112, 219, 0.8)';
            target.style.borderRadius = '8px';
            target.style.backgroundColor = 'rgba(147, 112, 219, 0.1)';

            // åˆ›å»ºæç¤ºæ¡†ï¼ˆç´«è‰²ä¸»é¢˜ï¼‰
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(147, 112, 219, 0.85);
                color: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(147, 112, 219, 0.4);
                max-width: 400px;
                z-index: 10001;
                text-align: center;
                animation: fadeIn 0.3s ease;
                border: 2px solid #9370DB;
                backdrop-filter: blur(10px);
            `;

            tooltip.innerHTML = `
                <h5 style="color: white; margin-bottom: 15px;">${title}</h5>
                <p style="margin-bottom: 20px; line-height: 1.6; color: #F8F8FF;">${description}</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="nextTutorialStep()" class="btn btn-light">ç»§ç»­ â†’</button>
                    <button onclick="skipTutorial()" class="btn btn-outline-light">è·³è¿‡æ•™ç¨‹</button>
                </div>
            `;

            document.body.appendChild(tooltip);

            window.nextTutorialStep = () => {
                // æ¢å¤åŸå§‹æ ·å¼
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                resolve();
            };

            window.skipTutorial = () => {
                // æ¢å¤åŸå§‹æ ·å¼
                Object.keys(originalStyle).forEach(key => {
                    target.style[key] = originalStyle[key];
                });
                tooltip.remove();
                removeTutorialOverlay();
                alert('æ•™ç¨‹å·²è·³è¿‡ï¼');
            };

            // è‡ªåŠ¨ç»§ç»­
            if (duration) {
                setTimeout(() => {
                    if (document.body.contains(tooltip)) {
                        window.nextTutorialStep();
                    }
                }, duration);
            }
        });
    }

    // ç§»é™¤æ•™ç¨‹é®ç½©å±‚
    function removeTutorialOverlay() {
        const overlay = document.getElementById('tutorial-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // åŸæœ‰çš„åŠŸèƒ½å‡½æ•°ä¿æŒä¸å˜
    // auto upload when selecting file
    document.getElementById('coverFile').addEventListener('change', async function() {
        const input = this;
        if (!input.files || !input.files[0]) return;
        try {
            const url = await uploadImage(input.files[0]);
            document.getElementById('cover').value = url;
            const pv = document.getElementById('coverPreview');
            pv.src = url;
            document.getElementById('cover-preview-container').style.display = 'block';
        } catch (e) {
            showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + (e && e.message ? e.message : e), false);
        } finally {
            input.value = '';
        }
    });

    // Handle Story Form (Create/Update)
    document.getElementById('story-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¼”ç¤ºæ¨¡å¼
        const urlParams = new URLSearchParams(window.location.search);
        const tutorialMode = urlParams.get('tutorial');
        if (tutorialMode === 'auto') {
            return; // æ¼”ç¤ºæ¨¡å¼ä¸‹ä¸æ‰§è¡Œå®é™…æäº¤
        }

        const storyData = {
            name: document.getElementById('name').value,
            introduction: document.getElementById('introduction').value,
            cover: document.getElementById('cover').value,
            max: parseInt(document.getElementById('max').value, 10),
            firstSceneId: document.getElementById('firstSceneSelect').value ? parseInt(document.getElementById('firstSceneSelect').value, 10) : null
        };

        const isUpdate = !!currentStoryId;
        const url = isUpdate ? `/api/stories/${currentStoryId}` : '/api/stories/create';
        const method = isUpdate ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(storyData)
            });
            const result = await response.json();
            const isSuccess = result && result.code === '200';
            showMessage(result ? (result.msg || (isSuccess ? 'Story saved successfully!' : 'An error occurred.')) : 'Unexpected response', isSuccess);

            if (isSuccess && !isUpdate) {
                window.location.search = `?storyId=${result.data}`;
            } else if (isSuccess) {
                // Refresh the page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        } catch (error) {
            showMessage('An unexpected error occurred.', false);
        }
    });

    async function loadStoryForEditing(storyId) {
        try {
            const response = await fetch(`/api/stories/${storyId}`);
            const result = await response.json();
            if (result && result.code === '200') {
                const story = result.data;
                document.getElementById('editor-title').textContent = `Editing: ${story.name}`;
                storyIdInput.value = story.id;
                document.getElementById('name').value = story.name;
                document.getElementById('introduction').value = story.introduction;
                document.getElementById('cover').value = story.cover || '';
                if (story.cover) {
                    const pv = document.getElementById('coverPreview');
                    pv.src = story.cover;
                    document.getElementById('cover-preview-container').style.display = 'block';
                }
                document.getElementById('max').value = story.max;
                // Pre-select first scene if present
                if (story.firstSceneId) {
                    const sel = document.getElementById('firstSceneSelect');
                    sel.value = story.firstSceneId;
                }
            } else {
                showMessage(result ? result.msg : 'Failed to load story details.', false);
            }
        } catch (error) {
            showMessage('Failed to load story details.', false);
        }
    }

    async function loadUserScenes() {
        try {
            const res = await fetch('/api/scenes/my-scenes');
            const result = await res.json();
            if (result && result.code === '200') {
                const select = document.getElementById('firstSceneSelect');
                // keep existing default option
                result.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.name} (id:${s.id})`;
                    select.appendChild(opt);
                });
            }
        } catch (err) {
            console.warn('æ— æ³•åŠ è½½ç”¨æˆ·åœºæ™¯åˆ—è¡¨', err);
        }
    }

    function showMessage(msg, isSuccess) {
        messageDiv.textContent = msg;
        messageDiv.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
    }

    async function uploadImage(file) {
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        let parsed = null;
        try {
            parsed = await res.clone().json();
        } catch (e) {
            const txt = await res.clone().text();
            throw new Error(`éJSONå“åº” (HTTP ${res.status}): ${txt.slice(0,200)}`);
        }
        if (!res.ok) {
            const msg = (parsed && parsed.msg) ? parsed.msg : `HTTP ${res.status} ${res.statusText}`;
            throw new Error(msg);
        }
        if (parsed && parsed.code === '200') {
            const data = parsed.data;
            return (data && (data.url || data)) || '';
        }
        throw new Error(parsed ? (parsed.msg || 'ä¸Šä¼ è¿”å›å¤±è´¥') : 'upload failed');
    }
</script>

<style>
    .text-purple {
        color: #9370DB !important;
    }
</style>
</body>
</html>